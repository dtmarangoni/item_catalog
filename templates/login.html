{% extends "main.html" %}

{% block meta_head %}
  <!--LOAD PRE-REQUISITES FOR GOOGLE SIGN IN -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script src="https://apis.google.com/js/platform.js?onload=start"></script>
  <script>
        gapi.load('auth2', function() {
            auth2 = gapi.auth2.init({
                client_id: 'INSERT YOUR WEB APP CLIENT ID',
                // Scopes to request in addition to 'profile' and 'email'
                // scope: 'additional_scope'
            });
        });
  </script>
{% endblock %}

{% block title %}Login{% endblock %}

{% block header %}
  <h1 class="display-5 text-center text-white font-weight-bold p-0 m-0">Login</h1>
{% endblock %}

{% block content %}
  <hr>

  <!-- Header -->
  <div class="row justify-content-center my-3">
    <div class="col-auto">
      <h3 class="dark_gray-font">Continue with</h3>
    </div>
  </div>

  <!-- Facebook and Google sign in -->
  <div class="row align-items-center justify-content-center my-3">
    <!-- Facebook sign in -->
    <div class="col-auto">

      <script>
        window.fbAsyncInit = function() {
          FB.init({
            appId      : 'INSERT YOUR WEB APP CLIENT ID',
            cookie     : true,    // enable cookies to allow the server to
                                  // access the session
            xfbml      : true,    // parse social plugins on this page
            version    : 'v3.2'   // The Graph API version to use for the call
          });
        };

        // Load the SDK asynchronously
        (function(d, s, id){
           var js, fjs = d.getElementsByTagName(s)[0];
           if (d.getElementById(id)) {return;}
           js = d.createElement(s); js.id = id;
           js.src = "https://connect.facebook.net/en_US/sdk.js";
           fjs.parentNode.insertBefore(js, fjs);
         }(document, 'script', 'facebook-jssdk'));

         // This function is called when someone finishes with the Login
         // Button.
         function checkLoginState() {
            FB.getLoginStatus(function(response) {
            // The response object is returned with a status field that
            // lets the app know the current login status of the person.
            // Full docs on the response object can be found in the
            // documentation for FB.getLoginStatus().
            if (response.status === 'connected') {
              // Logged into your app and Facebook.
              var access_token = response.authResponse.accessToken;

              FB.api('/me', function(response) {
                $.ajax({
                  type: 'POST',
                  url: '/catalog/oauth_login/facebook',
                  processData: false,
                  data: access_token,
                  contentType: 'application/octet-stream; charset=utf-8',
                  success: function(result) {
                    // Handle or verify the server response if necessary.
                    if (result) {
                      window.location.href = "/catalog";
                    } else {
                      console.log('Failed to make a server-side call. Check your configuration and console.');
                    }
                  }
                });
               });
            } else {
              // The person is not logged into your app or we are unable to tell.
              document.getElementById('status').innerHTML = 'Please log into this app.';
            }
          });
        }
      </script>

      <fb:login-button scope="public_profile,email" onlogin="checkLoginState();" data-size="large" data-button-type="login_with"></fb:login-button>
    </div>
    <!-- End Facebook sign in -->

    <!-- Google Plus sign in -->
    <div class="col-auto">
      <div
          class="g-signin2"
          id="signinButton"
          data-theme="dark"
          data-width="236"
          data-height="40"
          data-longtitle="true"
          data-scope="openid email"
          data-cookiepolicy="single_host_origin"
          data-approvalprompt="force">
        </div>
    </div>

    <script>
      $('#signinButton').click(function() {
          auth2.grantOfflineAccess({'redirect_uri': 'postmessage'}).then(signInCallback);
      });
    </script>

    <script>
      function signInCallback(json) {
        authResult = json;
        if (authResult['code']) {
          $.ajax({
            type: 'POST',
            url: '/catalog/oauth_login/google',
            processData: false,
            data: authResult['code'],
            contentType: 'application/octet-stream; charset=utf-8',
            success: function(result) {
              // Handle or verify the server response if necessary.
              if (result) {
              window.location.href = "/catalog";
              } else {
              console.log('Failed to make a server-side call. Check your configuration and console.');
              }
            }
          });
        } else if (authResult['error']) {
          console.log('There was an error: ' + authResult['error']);
        }
      }
    </script>

    </div>
    <!-- End Google Plus sign in -->
  </div>

  <div class="row align-items-center justify-content-center mt-4 mb-2">
    <div class="col-auto">
      <p class="dark_gray-font font-weight-bold">or</p>
    </div>
  </div>

  <!-- Alert in case of unsuccessful login attempt -->
  <div class="row align-items-center justify-content-center mb-1">
    <div class="col-auto">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="alert alert-dark alert-dismissible fade show" role="alert">
            {% for message in messages %}
              <p class="m-0 p-0">{{message}}</p>
            {% endfor %}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endif %}
      {% endwith %}
    </div>
  </div>

  <!-- Item Catalog sign in -->
  <div class="row align-items-center justify-content-center">
    <div class="col-auto">
      <form action="{{url_for('site_login')}}" method='POST'>
        <div class="row mb-2">
          <div class="col">
            <input type="text" class="form-control" name="username" placeholder="Username" required>
          </div>
        </div>
        <div class="row mb-2">
          <div class="col">
            <input type="password" class="form-control" name="password" placeholder="Password" required>
          </div>
        </div>
        <div class="row justify-content-around">
          <div class="col-auto">
            <button type="submit" class="btn text-white btn-danger font-weight-bold button-width-large mr-2 mt-2">Sign in</button>
            <a class="btn text-white orange-bg font-weight-bold button-width-large mt-2" href="{{ url_for('new_user') }}">Sign up</a>
          </div>
        </div>
      </form>
    </div>
  </div>

{% endblock %}